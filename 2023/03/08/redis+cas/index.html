<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="一名Java开发人员。">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          Redis + CAS，配置自增单号 - 邓佳的博客 | Jia Blog
        
    </title>

    <link rel="canonical" href="http://dengjia.top/2023/03/08/redis+cas/">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/hux-blog.min.css">


    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="/css/highlight.css">


    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Jia`s Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                        
                            <li>
                                <a href="/about/">About</a>
                            </li>
                        
                    
                        
                            <li>
                                <a href="/archives/">Archives</a>
                            </li>
                        
                    
                        
                    
                        
                            <li>
                                <a href="/tags/">Tags</a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)

    function handleMagic(e) {
        if ($navbar.className.indexOf('in') > 0) {
            // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function () {
                // prevent frequently toggle
                if ($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            }, 400)
        } else {
            // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


<!-- Main Content -->

<!-- Image to hack wechat -->
<!-- <img src="http://dengjia.top/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/index.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#Redis" title="Redis">Redis</a>
                        
                          <a class="tag" href="/tags/#Java" title="Java">Java</a>
                        
                          <a class="tag" href="/tags/#CAS" title="CAS">CAS</a>
                        
                    </div>
                    <h1>Redis + CAS，配置自增单号</h1>
                    <h2 class="subheading">Redis + CAS（乐观锁），配置自增业务单号</h2>
                    <span class="meta">
                        Posted by Deng Jia on
                        2023-03-08
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h2 id="DB-脚本"><a href="#DB-脚本" class="headerlink" title="DB 脚本"></a>DB 脚本</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for log_czrz</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `log_czrz`</span><br><span class="line">(</span><br><span class="line">    `id`             <span class="type">int</span>(<span class="number">11</span>)                                                  <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">    `SQBM`           <span class="type">varchar</span>(<span class="number">32</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci   <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;社区编码&#x27;</span>,</span><br><span class="line">    `table_name`     <span class="type">varchar</span>(<span class="number">32</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci   <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;表名&#x27;</span>,</span><br><span class="line">    `table_id`       <span class="type">varchar</span>(<span class="number">64</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci   <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;表主键&#x27;</span>,</span><br><span class="line">    `table_column`   <span class="type">varchar</span>(<span class="number">1000</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;医保目录编码&#x27;</span>,</span><br><span class="line">    `xgysbm`         <span class="type">varchar</span>(<span class="number">32</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci   <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改医生编码&#x27;</span>,</span><br><span class="line">    `xgysmc`         <span class="type">varchar</span>(<span class="number">32</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin          <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更改医生名称&#x27;</span>,</span><br><span class="line">    `xgxx`           longtext <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci      <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改信息&#x27;</span>,</span><br><span class="line">    `xgrq`           <span class="type">int</span>(<span class="number">11</span>)                                                  <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改日期&#x27;</span>,</span><br><span class="line">    `xgsj`           <span class="type">int</span>(<span class="number">11</span>)                                                  <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">    `machine_ip`     <span class="type">varchar</span>(<span class="number">32</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci   <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ip&#x27;</span>,</span><br><span class="line">    `machine_name`   <span class="type">varchar</span>(<span class="number">32</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci   <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;ip名称&#x27;</span>,</span><br><span class="line">    `System_version` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci  <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;电脑系统版本&#x27;</span>,</span><br><span class="line">    `created_at`     <span class="type">timestamp</span>                                                <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    `updated_at`     <span class="type">timestamp</span>                                                <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> UPDATE <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">    <span class="comment">-- AUTO_INCREMENT = 5135</span></span><br><span class="line">  <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8</span><br><span class="line">  <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci COMMENT <span class="operator">=</span> <span class="string">&#x27;药房库存修改药品有效期日志表&#x27;</span></span><br><span class="line">  ROW_FORMAT <span class="operator">=</span> Compact;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for ywdh_config</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ywdh_config`</span><br><span class="line">(</span><br><span class="line">    `PKYWDHCONFIG` <span class="type">int</span>(<span class="number">11</span>)                                                <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;业务单号设置自增主键&#x27;</span>,</span><br><span class="line">    `SQBM`         <span class="type">varchar</span>(<span class="number">20</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;社区编码&#x27;</span>,</span><br><span class="line">    `LX`           <span class="type">int</span>(<span class="number">2</span>)                                                 <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;单号类型（1药库采购、4药库验收、2药库入库、3药库出库...）&#x27;</span>,</span><br><span class="line">    `KSLX`         <span class="type">int</span>(<span class="number">5</span>)                                                 <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;科室类型（对应zd_ks科室的主键id）&#x27;</span>,</span><br><span class="line">    `JTLX`         <span class="type">int</span>(<span class="number">5</span>)                                                 <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;具体类型（将单号类型进一步细分的具体类型）&#x27;</span>,</span><br><span class="line">    `CZRYID`       <span class="type">int</span>(<span class="number">11</span>)                                                <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;操作人员id&#x27;</span>,</span><br><span class="line">    `DHQZ`         <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;单号前缀&#x27;</span>,</span><br><span class="line">    `DHCD`         <span class="type">int</span>(<span class="number">5</span>)                                                 <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;单号长度（不含前缀）&#x27;</span>,</span><br><span class="line">    `DHQSH`        <span class="type">int</span>(<span class="number">5</span>)                                                 <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;单号起始号&#x27;</span>,</span><br><span class="line">    `DHBC`         <span class="type">int</span>(<span class="number">5</span>)                                                 <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;单号步长&#x27;</span>,</span><br><span class="line">    `ISOPEN`       <span class="type">int</span>(<span class="number">2</span>)                                                 <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;是否开启（1开启为递增序列，0不开启为时间戳随机序列）&#x27;</span>,</span><br><span class="line">    `CURRENTTIME`  <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span>     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;时间戳&#x27;</span>,</span><br><span class="line">    `CREATEDAT`    <span class="type">timestamp</span>                                              <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建日期&#x27;</span>,</span><br><span class="line">    `UPDATEDAT`    <span class="type">timestamp</span>                                              <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> UPDATE <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新日期&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`PKYWDHCONFIG`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">    <span class="comment">-- AUTO_INCREMENT = 180</span></span><br><span class="line">  <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8</span><br><span class="line">  <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci COMMENT <span class="operator">=</span> <span class="string">&#x27;业务单号生成规则配置&#x27;</span></span><br><span class="line">  ROW_FORMAT <span class="operator">=</span> Compact;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for ywdh_redis_pair</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ywdh_redis_pair`</span><br><span class="line">(</span><br><span class="line">    `PKPAIR`      <span class="type">int</span>(<span class="number">11</span>)                                                 <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;键值对主键pk&#x27;</span>,</span><br><span class="line">    `SQBM`        <span class="type">varchar</span>(<span class="number">20</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;社区编码&#x27;</span>,</span><br><span class="line">    `CURRENTTIME` <span class="type">varchar</span>(<span class="number">15</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci  <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;时间戳&#x27;</span>,</span><br><span class="line">    `KEYNAME`     <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;键&#x27;</span>,</span><br><span class="line">    `<span class="keyword">VALUE</span>`       <span class="type">varchar</span>(<span class="number">20</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci  <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;值&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`PKPAIR`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">    <span class="comment">-- AUTO_INCREMENT = 214</span></span><br><span class="line">  <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8</span><br><span class="line">  <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci COMMENT <span class="operator">=</span> <span class="string">&#x27;业务单号键值对&#x27;</span></span><br><span class="line">  ROW_FORMAT <span class="operator">=</span> Compact;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Entity"><a href="#Entity" class="headerlink" title="Entity"></a>Entity</h2><h3 id="YwdhConfig（业务单号配置）"><a href="#YwdhConfig（业务单号配置）" class="headerlink" title="YwdhConfig（业务单号配置）"></a>YwdhConfig（业务单号配置）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: DengJia</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/2/14 10:44</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 业务单号配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YwdhConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 药库单号设置自增主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer pkywdhconfig;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 社区编码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String sqbm;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单号类型（1药库采购、2药库入库、3药库出库...）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer lx;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 科室类型（对应zd_ks科室的主键id）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer kslx;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 具体类型（将单号类型进一步细分的具体类型）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer jtlx;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作人员id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer czryid;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单号前缀</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String dhqz;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单号长度（不含前缀）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer dhcd;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单号起始号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer dhqsh;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单号步长</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer dhbc;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否开启（1开启为递增序列，0不开启为时间戳随机序列）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer isopen;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String currenttime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date createdAt;</span><br><span class="line">    <span class="keyword">private</span> Date updatedAt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="YwdhRedisPair（Redis键值对）"><a href="#YwdhRedisPair（Redis键值对）" class="headerlink" title="YwdhRedisPair（Redis键值对）"></a>YwdhRedisPair（Redis键值对）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: DengJia</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/2/17 9:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: redis键值对</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YwdhRedisPair</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer pkpair;</span><br><span class="line">    <span class="keyword">private</span> String currenttime;</span><br><span class="line">    <span class="keyword">private</span> String sqbm;</span><br><span class="line">    <span class="keyword">private</span> String keyname;</span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">YwdhRedisPair</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">YwdhRedisPair</span><span class="params">(String sqbm, String currenttime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.currenttime = currenttime;</span><br><span class="line">        <span class="keyword">this</span>.sqbm = sqbm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">YwdhRedisPair</span><span class="params">(Integer pkpair, String currenttime, String sqbm, String keyname, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pkpair = pkpair;</span><br><span class="line">        <span class="keyword">this</span>.currenttime = currenttime;</span><br><span class="line">        <span class="keyword">this</span>.sqbm = sqbm;</span><br><span class="line">        <span class="keyword">this</span>.keyname = keyname;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Mapping"><a href="#Mapping" class="headerlink" title="Mapping"></a>Mapping</h2><h3 id="YwdhConfig-hbm-xml"><a href="#YwdhConfig-hbm-xml" class="headerlink" title="YwdhConfig.hbm.xml"></a>YwdhConfig.hbm.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">hibernate-mapping</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//Hibernate/Hibernate Mapping DTD 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">hibernate-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">class</span> <span class="attr">name</span>=<span class="string">&quot;com.yuanbo.chss.domain.business.YwdhConfig&quot;</span> <span class="attr">table</span>=<span class="string">&quot;ywdh_config&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">name</span>=<span class="string">&quot;pkywdhconfig&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;PKYWDHCONFIG&quot;</span> <span class="attr">precision</span>=<span class="string">&quot;11&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">generator</span> <span class="attr">class</span>=<span class="string">&quot;identity&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqbm&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;SQBM&quot;</span> <span class="attr">sql-type</span>=<span class="string">&quot;varchar(20)&quot;</span> <span class="attr">length</span>=<span class="string">&quot;20&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;lx&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;LX&quot;</span> <span class="attr">precision</span>=<span class="string">&quot;2&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;kslx&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;KSLX&quot;</span> <span class="attr">precision</span>=<span class="string">&quot;5&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jtlx&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;JTLX&quot;</span> <span class="attr">precision</span>=<span class="string">&quot;5&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;czryid&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;CZRYID&quot;</span> <span class="attr">precision</span>=<span class="string">&quot;11&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dhqz&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;DHQZ&quot;</span> <span class="attr">sql-type</span>=<span class="string">&quot;varchar(10)&quot;</span> <span class="attr">length</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dhcd&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;DHCD&quot;</span> <span class="attr">precision</span>=<span class="string">&quot;5&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dhqsh&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;DHQSH&quot;</span> <span class="attr">precision</span>=<span class="string">&quot;5&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dhbc&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;DHBC&quot;</span> <span class="attr">precision</span>=<span class="string">&quot;2&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;isopen&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;ISOPEN&quot;</span> <span class="attr">precision</span>=<span class="string">&quot;2&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;currenttime&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;CURRENTTIME&quot;</span> <span class="attr">sql-type</span>=<span class="string">&quot;varchar(50)&quot;</span> <span class="attr">length</span>=<span class="string">&quot;50&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">hibernate-mapping</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="YwdhRedisPair-hbm-xml"><a href="#YwdhRedisPair-hbm-xml" class="headerlink" title="YwdhRedisPair.hbm.xml"></a>YwdhRedisPair.hbm.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">hibernate-mapping</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//Hibernate/Hibernate Mapping DTD 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">hibernate-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">class</span> <span class="attr">name</span>=<span class="string">&quot;com.yuanbo.chss.domain.business.YwdhRedisPair&quot;</span> <span class="attr">table</span>=<span class="string">&quot;ywdh_redis_pair&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">name</span>=<span class="string">&quot;pkpair&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;PKPAIR&quot;</span> <span class="attr">precision</span>=<span class="string">&quot;11&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">generator</span> <span class="attr">class</span>=<span class="string">&quot;identity&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqbm&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;SQBM&quot;</span> <span class="attr">sql-type</span>=<span class="string">&quot;varchar(20)&quot;</span> <span class="attr">length</span>=<span class="string">&quot;20&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;currenttime&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;CURRENTTIME&quot;</span> <span class="attr">sql-type</span>=<span class="string">&quot;varchar(15)&quot;</span> <span class="attr">length</span>=<span class="string">&quot;15&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;keyname&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;KEYNAME&quot;</span> <span class="attr">sql-type</span>=<span class="string">&quot;varchar(100)&quot;</span> <span class="attr">length</span>=<span class="string">&quot;100&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;value&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;VALUE&quot;</span> <span class="attr">sql-type</span>=<span class="string">&quot;varchar(20)&quot;</span> <span class="attr">length</span>=<span class="string">&quot;20&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">hibernate-mapping</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Enum"><a href="#Enum" class="headerlink" title="Enum"></a>Enum</h2><h3 id="YwdhOpsEnum（业务单号操作，枚举类）"><a href="#YwdhOpsEnum（业务单号操作，枚举类）" class="headerlink" title="YwdhOpsEnum（业务单号操作，枚举类）"></a>YwdhOpsEnum（业务单号操作，枚举类）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.yuanbo.common.util.G3GlobalNames;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Stream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: DengJia</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/2/10 11:31</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 业务单号操作，枚举类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">YwdhOpsEnum</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 药库采购</span></span><br><span class="line">    PURCHASE(G3GlobalNames.YK_CGD0, <span class="number">1</span>),</span><br><span class="line">    <span class="comment">// 药库验收</span></span><br><span class="line">    ACCEPTANCE(G3GlobalNames.YK_YSD0, <span class="number">4</span>),</span><br><span class="line">    <span class="comment">// 药库入库</span></span><br><span class="line">    INBOUND(G3GlobalNames.YK_RKD0, <span class="number">2</span>),</span><br><span class="line">    <span class="comment">// 药库出库</span></span><br><span class="line">    OUTBOUND(G3GlobalNames.YK_CKD0, <span class="number">3</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long opcode;</span><br><span class="line">    <span class="keyword">private</span> Integer lx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取对应类型的操作码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lx 类型值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 操作码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title">getOpcode</span><span class="params">(Integer lx)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Stream.of(YwdhOpsEnum.values())</span><br><span class="line">                .filter(e -&gt; Objects.equals(e.getLx(), lx))</span><br><span class="line">                .findFirst().map(e -&gt; e.opcode)</span><br><span class="line">                <span class="comment">// 如果lx不存在，opcode返回无效值：-1L</span></span><br><span class="line">                .orElse(-<span class="number">1L</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取操作码的类型</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> opcode 药库操作的编码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 类型值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">getLx</span><span class="params">(<span class="keyword">long</span> opcode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Stream.of(YwdhOpsEnum.values())</span><br><span class="line">                .filter(e -&gt; Objects.equals(e.getOpcode(), opcode))</span><br><span class="line">                .findFirst().map(e -&gt; e.lx)</span><br><span class="line">                <span class="comment">// 如果opcode不存在，lx返回无效值：-1</span></span><br><span class="line">                .orElse(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    YwdhOpsEnum(Long opcode, Integer lx) &#123;</span><br><span class="line">        <span class="keyword">this</span>.opcode = opcode;</span><br><span class="line">        <span class="keyword">this</span>.lx = lx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getOpcode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> opcode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOpcode</span><span class="params">(Long opcode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.opcode = opcode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getLx</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLx</span><span class="params">(Integer lx)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lx = lx;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Repository"><a href="#Repository" class="headerlink" title="Repository"></a>Repository</h2><h3 id="YwdhConfigRepository（业务单号配置-Repository）"><a href="#YwdhConfigRepository（业务单号配置-Repository）" class="headerlink" title="YwdhConfigRepository（业务单号配置 Repository）"></a>YwdhConfigRepository（业务单号配置 Repository）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.yuanbo.chss.domain.business.YwdhConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: DengJia</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/2/14 14:30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 药库单号配置 Repository</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">YwdhConfigRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询业务单号配置，入参含主键则通过主键查询，否则按条件查询。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataMap 过滤条件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 配置信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; selectYwdhConfig(Map&lt;String, Object&gt; dataMap);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户自定义配置业务单号格式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dbBean    原值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramBean 修改值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateYwdhConfig</span><span class="params">(YwdhConfig dbBean, YwdhConfig paramBean)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除单号配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ids 待删除单号主键ids</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteBusinessNumConfigByIds</span><span class="params">(List&lt;Integer&gt; ids)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="YwdhConfigRepositoryImpl（业务单号配置-RepositoryImpl）"><a href="#YwdhConfigRepositoryImpl（业务单号配置-RepositoryImpl）" class="headerlink" title="YwdhConfigRepositoryImpl（业务单号配置 RepositoryImpl）"></a>YwdhConfigRepositoryImpl（业务单号配置 RepositoryImpl）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.yuanbo.chss.domain.business.YwdhConfig;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.common.util.LoginHelper;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.hap.util.DBAgent;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.yuanbo.hap.util.ParamUtil.beanToMap;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.yuanbo.hap.util.ParamUtil.mapToBean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: DengJia</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/2/14 14:39</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 业务单号配置 RepositoryImpl</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository(&quot;YwdhConfigRepository&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YwdhConfigRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">YwdhConfigRepository</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DBAgent DBA = DBAgent.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; selectYwdhConfig(Map&lt;String, Object&gt; dataMap) &#123;</span><br><span class="line">        StringBuilder querySql = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;select * from ywdh_config where sqbm = ::SQBM &quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;PKYWDHCONFIG&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            querySql.append(<span class="string">&quot;and pkywdhconfig = ::PKYWDHCONFIG &quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;LX&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                querySql.append(<span class="string">&quot;and lx = ::LX &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;KSLX&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                querySql.append(<span class="string">&quot;and kslx = ::KSLX &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;JTLX&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                querySql.append(<span class="string">&quot;and jtlx = ::JTLX &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//            if (dataMap.get(&quot;CZRYID&quot;) != null) &#123;</span></span><br><span class="line"><span class="comment">//                querySql.append(&quot;and czryid = ::CZRYID &quot;);</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line">            <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;DHQZ&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                querySql.append(<span class="string">&quot;and dhqz = :DHQZ &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;DHCD&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                querySql.append(<span class="string">&quot;and dhcd = ::DHCD &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;DHQSH&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                querySql.append(<span class="string">&quot;and dhqsh = ::DHQSH &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;DHBC&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                querySql.append(<span class="string">&quot;and dhbc = ::DHBC &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;ISOPEN&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                querySql.append(<span class="string">&quot;and isopen = ::ISOPEN &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;CURRENTTIME&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                querySql.append(<span class="string">&quot;and currenttime = ::CURRENTTIME &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> DBA.querySQL(querySql.toString(), dataMap, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateYwdhConfig</span><span class="params">(YwdhConfig dbBean, YwdhConfig paramBean)</span> </span>&#123;</span><br><span class="line">        YwdhConfig config = <span class="keyword">new</span> YwdhConfig();</span><br><span class="line">        <span class="comment">// 浅拷贝</span></span><br><span class="line">        BeanUtils.copyProperties(paramBean, config);</span><br><span class="line">        <span class="keyword">if</span> (config.getLx() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            config.setLx(dbBean.getLx());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config.getKslx() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            config.setKslx(dbBean.getKslx());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config.getJtlx() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            config.setJtlx(dbBean.getJtlx());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config.getCzryid() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            config.setCzryid(dbBean.getCzryid());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config.getDhqz() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            config.setDhqz(dbBean.getDhqz());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config.getDhcd() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            config.setDhcd(dbBean.getDhcd());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config.getDhqsh() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            config.setDhqsh(dbBean.getDhqsh());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config.getDhbc() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            config.setDhbc(dbBean.getDhbc());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config.getIsopen() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            config.setIsopen(dbBean.getIsopen());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config.getCurrenttime() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            config.setCurrenttime(dbBean.getCurrenttime());</span><br><span class="line">        &#125;</span><br><span class="line">        config.setCreatedAt(dbBean.getCreatedAt());</span><br><span class="line">        DBA.update(<span class="keyword">null</span>, config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteBusinessNumConfigByIds</span><span class="params">(List&lt;Integer&gt; ids)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 去掉字符串前后中括号</span></span><br><span class="line">        String strIds = org.apache.commons.lang3.StringUtils.strip(ids.toString(), <span class="string">&quot;[]&quot;</span>);</span><br><span class="line">        DBA.executeProcSql(<span class="string">&quot;delete from ywdh_config where pkywdhconfig in ( &quot;</span> + strIds + <span class="string">&quot; )&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="YwdhRedisPairRepository（Redis键值对配置-Repository）"><a href="#YwdhRedisPairRepository（Redis键值对配置-Repository）" class="headerlink" title="YwdhRedisPairRepository（Redis键值对配置 Repository）"></a>YwdhRedisPairRepository（Redis键值对配置 Repository）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.yuanbo.chss.domain.business.YwdhRedisPair;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">YwdhRedisPairRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;YwdhRedisPair&gt; <span class="title">selectYwdhKeyConfig</span><span class="params">(YwdhRedisPair ywdhRedisPair)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertYwdhRedisPair</span><span class="params">(YwdhRedisPair ywdhRedisPair)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateYwdhKeyConfig</span><span class="params">(YwdhRedisPair ywdhRedisPair)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteYwdhKeyConfig</span><span class="params">(YwdhRedisPair ywdhRedisPair)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="YwdhRedisPairRepositoryImpl（Redis键值对配置-RepositoryImpl）"><a href="#YwdhRedisPairRepositoryImpl（Redis键值对配置-RepositoryImpl）" class="headerlink" title="YwdhRedisPairRepositoryImpl（Redis键值对配置 RepositoryImpl）"></a>YwdhRedisPairRepositoryImpl（Redis键值对配置 RepositoryImpl）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.yuanbo.chss.domain.business.YwdhRedisPair;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.hap.util.DBAgent;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.hap.util.ParamUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: DengJia</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/2/17 11:28</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository(&quot;YwdhRedisPairRepository&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YwdhRedisPairRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">YwdhRedisPairRepository</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DBAgent DBA = DBAgent.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;YwdhRedisPair&gt; <span class="title">selectYwdhKeyConfig</span><span class="params">(YwdhRedisPair ywdhRedisPair)</span> </span>&#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; dataMap = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">        ParamUtil.beanToMap(ywdhRedisPair, dataMap, <span class="keyword">true</span>);</span><br><span class="line">        StringBuilder querySql = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;select * from ywdh_redis_pair where sqbm = :sqbm &quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;pkpair&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            querySql.append(<span class="string">&quot;and pkpair = :pkpair &quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;fkywdhconfig&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                querySql.append(<span class="string">&quot;and fkywdhconfig = :fkywdhconfig &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;currenttime&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                querySql.append(<span class="string">&quot;and currenttime = :currenttime &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;keyname&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                querySql.append(<span class="string">&quot;and keyname = :keyname &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;value&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                querySql.append(<span class="string">&quot;and value = :value &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; list = DBA.querySQL(querySql.toString(), dataMap, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> ParamUtil.mapsToBeans(list, YwdhRedisPair.class, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertYwdhRedisPair</span><span class="params">(YwdhRedisPair ywdhRedisPair)</span> </span>&#123;</span><br><span class="line">        DBA.save(<span class="keyword">null</span>, ywdhRedisPair);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateYwdhKeyConfig</span><span class="params">(YwdhRedisPair ywdhRedisPair)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="comment">//        map.put(&quot;SQBM&quot;, ywdhRedisPair.getSqbm());</span></span><br><span class="line"><span class="comment">//        map.put(&quot;KEYNAME&quot;, ywdhRedisPair.getKeyname());</span></span><br><span class="line"><span class="comment">//        if (ywdhRedisPair.getValue() != null) &#123;</span></span><br><span class="line"><span class="comment">//            map.put(&quot;VALUE&quot;, ywdhRedisPair.getValue());</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        StringBuilder sb = new StringBuilder(&quot;update ywdh_redis_pair set value = 3 &quot;);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        sb.append(&quot;where sqbm = ::SQBM and keyname = ::KEYNAME&quot;);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        DBA.executeSQL(sb.toString(), );</span></span><br><span class="line">        DBA.update(<span class="keyword">null</span>, ywdhRedisPair);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteYwdhKeyConfig</span><span class="params">(YwdhRedisPair ywdhRedisPair)</span> </span>&#123;</span><br><span class="line">        DBA.delete(<span class="keyword">null</span>, ywdhRedisPair);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><h3 id="YwdhConfigBS（业务单号配置-业务接口）"><a href="#YwdhConfigBS（业务单号配置-业务接口）" class="headerlink" title="YwdhConfigBS（业务单号配置 业务接口）"></a>YwdhConfigBS（业务单号配置 业务接口）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.yuanbo.chss.domain.business.YwdhConfig;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.hap.webservice.function.FuncResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * his业务单号配置 业务接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">YwdhConfigBS</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建单号生成规则的时候，也生成redis键，由于redis未进行持久化配置，同时需要将key记录进mysql。</span></span><br><span class="line"><span class="comment">     * 客户端传入的JTLX，代表多条具体类型，以 &#x27;,&#x27; 逗号分割，分别存储。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataMap 配置信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 添加成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">FuncResult <span class="title">createBusinessNumConfig</span><span class="params">(Map&lt;String, Object&gt; dataMap)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 条件查询业务单号配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataMap 查询条件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 按条件过滤后的配置信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">FuncResult <span class="title">queryBusinessNumConfig</span><span class="params">(Map&lt;String, Object&gt; dataMap)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按入参TYPE分别进行修改、新增、删除</span></span><br><span class="line"><span class="comment">     * 通过时间戳字段(CURRENTTIME)实现乐观锁机制（修改之前查出来的时间戳与数据库的时间戳进行对比，一致方可进行本次修改）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataMap 入参</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 修改成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">FuncResult <span class="title">updateBusinessNumConfigByType</span><span class="params">(Map&lt;String, Object&gt; dataMap)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除业务单号配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataMap 待删除的配置主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 删除成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">FuncResult <span class="title">deleteBusinessNumConfigByType</span><span class="params">(Map&lt;String, Object&gt; dataMap)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="YwdhConfigBSImpl（业务单号配置-业务类）"><a href="#YwdhConfigBSImpl（业务单号配置-业务类）" class="headerlink" title="YwdhConfigBSImpl（业务单号配置 业务类）"></a>YwdhConfigBSImpl（业务单号配置 业务类）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.yuanbo.chss.domain.business.YwdhConfig;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.chss.domain.business.YwdhRedisPair;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.chss.domain.log.LogCzrz;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.chss.domain.yk.YwdhOpsEnum;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.chss.repository.YwdhConfigRepository;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.chss.repository.YwdhRedisPairRepository;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.common.util.DateTransUtil;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.common.util.LoginHelper;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.hap.core.exception.AppException;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.hap.util.DBAgent;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.hap.util.WebServiceUtils;</span><br><span class="line"><span class="keyword">import</span> com.yuanbo.hap.webservice.function.FuncResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.UnknownHostException;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.yuanbo.hap.util.ParamUtil.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.yuanbo.hap.util.ParamUtil.mapToBean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: DengJia</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/2/14 14:30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 业务单号配置 业务类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(&quot;YwdhConfigBS&quot;)</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YwdhConfigBSImpl</span> <span class="keyword">implements</span> <span class="title">YwdhConfigBS</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> YwdhConfigRepository ywdhConfigRepository;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> YwdhRedisPairRepository ywdhRedisPairRepository;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;Object, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX = <span class="string">&quot;INCR&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DBAgent DBA = DBAgent.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 乐观锁机制下执行数据的改动（UPDATE、DELETE）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String OPTIMISTIC_LOCK_UPDATE = <span class="string">&quot;UPDATE&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String OPTIMISTIC_LOCK_DELETE = <span class="string">&quot;DELETE&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FuncResult <span class="title">createBusinessNumConfig</span><span class="params">(Map&lt;String, Object&gt; dataMap)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 入参校验</span></span><br><span class="line">        <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;SQBM&quot;</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            dataMap.put(<span class="string">&quot;SQBM&quot;</span>, LoginHelper.getLoginerSQBM());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;CZRYID&quot;</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            dataMap.put(<span class="string">&quot;CZRYID&quot;</span>, LoginHelper.getLoginerId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;LX&quot;</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AppException(<span class="string">&quot;LX不可为空！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;KSLX&quot;</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AppException(<span class="string">&quot;KSLX不可为空！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;YwdhConfig&gt; configs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        StringBuilder rklxString = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        List&lt;Integer&gt; rklxList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;JTLX&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String jtlxString = dataMap.get(<span class="string">&quot;JTLX&quot;</span>).toString();</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotBlank(jtlxString)) &#123;</span><br><span class="line">                    String[] jtlxs = jtlxString.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                    configs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                    <span class="keyword">for</span> (String jtlx : jtlxs) &#123;</span><br><span class="line">                        <span class="keyword">int</span> i = Integer.parseInt(jtlx.trim());</span><br><span class="line">                        dataMap.put(<span class="string">&quot;JTLX&quot;</span>, i);</span><br><span class="line">                        configs.add(getBean(dataMap));</span><br><span class="line">                        rklxList.add(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AppException(<span class="string">&quot;请将JTLX以逗号分割传入！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            configs.add(getBean(dataMap));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查可行性，及后续操作</span></span><br><span class="line">        configs.forEach(<span class="keyword">this</span>::checkAvailability);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为多个具体类型设置同一套规则（一次添加一套规则）</span></span><br><span class="line">        String nowTimeString = String.valueOf(System.currentTimeMillis());</span><br><span class="line">        System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (YwdhConfig config : configs) &#123;</span><br><span class="line">            config.setCurrenttime(nowTimeString);</span><br><span class="line">            <span class="comment">// mysql保存自定义的规则</span></span><br><span class="line">            DBA.save(<span class="keyword">null</span>, config);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成key</span></span><br><span class="line">        StringBuilder keyName = <span class="keyword">new</span> StringBuilder(PREFIX + <span class="string">&quot;_&quot;</span> + dataMap.get(<span class="string">&quot;SQBM&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;LX&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Long dhlx = YwdhOpsEnum.getOpcode(Integer.parseInt(dataMap.get(<span class="string">&quot;LX&quot;</span>).toString()));</span><br><span class="line">            keyName.append(<span class="string">&quot;_&quot;</span>).append(dhlx);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;KSLX&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Integer kslx = Integer.parseInt(dataMap.get(<span class="string">&quot;KSLX&quot;</span>).toString());</span><br><span class="line">            keyName.append(<span class="string">&quot;_&quot;</span>).append(kslx);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!rklxList.isEmpty()) &#123;</span><br><span class="line">            Collections.sort(rklxList);</span><br><span class="line">            rklxList.forEach(rklxString::append);</span><br><span class="line">            keyName.append(<span class="string">&quot;_&quot;</span>).append(rklxString);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mysql保存键</span></span><br><span class="line">        YwdhRedisPair pair = <span class="keyword">new</span> YwdhRedisPair();</span><br><span class="line">        pair.setCurrenttime(nowTimeString);</span><br><span class="line">        pair.setSqbm(dataMap.get(<span class="string">&quot;SQBM&quot;</span>).toString());</span><br><span class="line">        pair.setKeyname(keyName.toString());</span><br><span class="line">        pair.setValue(dataMap.get(<span class="string">&quot;DHQSH&quot;</span>).toString());</span><br><span class="line">        ywdhRedisPairRepository.insertYwdhRedisPair(pair);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// redis设置键</span></span><br><span class="line">        callRedisToSetKeyAndExpiration(keyName.toString(), Integer.parseInt(dataMap.get(<span class="string">&quot;DHQSH&quot;</span>).toString()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FuncResult().setMsg(<span class="string">&quot;添加成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FuncResult <span class="title">queryBusinessNumConfig</span><span class="params">(Map&lt;String, Object&gt; dataMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;SQBM&quot;</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            dataMap.put(<span class="string">&quot;SQBM&quot;</span>, LoginHelper.getLoginerSQBM());</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; list = ywdhConfigRepository.selectYwdhConfig(dataMap);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FuncResult().addDataSet(<span class="string">&quot;YWDHCONFIG&quot;</span>, list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FuncResult <span class="title">updateBusinessNumConfigByType</span><span class="params">(Map&lt;String, Object&gt; dataMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String currentTimeMillis = String.valueOf(System.currentTimeMillis());</span><br><span class="line">        String sqbm = LoginHelper.getLoginerSQBM();</span><br><span class="line">        Integer czryid = Integer.parseInt(LoginHelper.getLoginerId().toString());</span><br><span class="line">        List[] listArray = (List[]) dataMap.get(<span class="string">&quot;YWDHCONFIG&quot;</span>);</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; configMapList = listArray[<span class="number">0</span>];</span><br><span class="line">        List&lt;String&gt; flagList = listArray[<span class="number">1</span>];</span><br><span class="line">        List&lt;YwdhConfig&gt; configBeanList = mapsToBeans(configMapList, YwdhConfig.class, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> dataSize = configMapList.size();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置操作人员</span></span><br><span class="line">        configBeanList.forEach(b -&gt; b.setCzryid(czryid));</span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt;</span><br><span class="line">                <span class="comment">// 之前的具体类型列表</span></span><br><span class="line">                jtlxList0 = <span class="keyword">new</span> ArrayList&lt;&gt;(),</span><br><span class="line">                <span class="comment">// 现在的具体类型列表</span></span><br><span class="line">                jtlxList1 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        StringBuilder</span><br><span class="line">                <span class="comment">// 之前的redis后缀</span></span><br><span class="line">                jtlxStr0 = <span class="keyword">new</span> StringBuilder(),</span><br><span class="line">                <span class="comment">// 现在的redis后缀</span></span><br><span class="line">                jtlxStr1 = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> addSize = <span class="number">0</span>, updateSize = <span class="number">0</span>, deleteSize = <span class="number">0</span>, unChangedSize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String rowOp_unchange = <span class="string">&quot;UnChanged&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (String flag : flagList) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (flag) &#123;</span><br><span class="line">                <span class="keyword">case</span> WebServiceUtils.rowOp_add:</span><br><span class="line">                    addSize++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> WebServiceUtils.rowOp_delete:</span><br><span class="line">                    deleteSize++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> WebServiceUtils.rowOp_update:</span><br><span class="line">                    updateSize++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> rowOp_unchange:</span><br><span class="line">                    unChangedSize++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span></span><br><span class="line">                onlyAdd = addSize == dataSize,</span><br><span class="line">                onlyDelete = deleteSize == dataSize,</span><br><span class="line">                onlyUpdate = updateSize == dataSize,</span><br><span class="line">                unChange = unChangedSize == dataSize;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unChange) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FuncResult().setMsg(<span class="string">&quot;修改成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (onlyAdd) &#123;</span><br><span class="line">            doOnlyAddAction(configBeanList, jtlxList0, jtlxList1, currentTimeMillis);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (onlyDelete) &#123;</span><br><span class="line">            doOnlyDeleteAction(configBeanList, jtlxList0, jtlxList1, currentTimeMillis);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            doElseAction(listArray, jtlxList0, jtlxList1, onlyUpdate, currentTimeMillis);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Collections.sort(jtlxList0);</span><br><span class="line">        Collections.sort(jtlxList1);</span><br><span class="line"></span><br><span class="line">        jtlxList0.forEach(jtlxStr0::append);</span><br><span class="line">        jtlxList1.forEach(jtlxStr1::append);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 做好Redis的同步以及MySQL的数据备份</span></span><br><span class="line">        syncAndBackup(configBeanList, jtlxStr0, jtlxStr1, currentTimeMillis);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FuncResult().setMsg(<span class="string">&quot;修改成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FuncResult <span class="title">deleteBusinessNumConfigByType</span><span class="params">(Map&lt;String, Object&gt; dataMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (dataMap.get(<span class="string">&quot;YWDHCONFIG&quot;</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AppException(<span class="string">&quot;YWDHCONFIG不可为空！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        List[] lists = (List[]) dataMap.get(<span class="string">&quot;YWDHCONFIG&quot;</span>);</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; ywdhConfigs = lists[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; ywdhConfigMap : ywdhConfigs) &#123;</span><br><span class="line">            <span class="comment">// 条件校验</span></span><br><span class="line">            <span class="keyword">if</span> (ywdhConfigMap.get(<span class="string">&quot;SQBM&quot;</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                ywdhConfigMap.put(<span class="string">&quot;SQBM&quot;</span>, LoginHelper.getLoginerSQBM());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ywdhConfigMap.get(<span class="string">&quot;CZRYID&quot;</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                ywdhConfigMap.put(<span class="string">&quot;CZRYID&quot;</span>, LoginHelper.getLoginerId());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ywdhConfigMap.get(<span class="string">&quot;PKYWDHCONFIG&quot;</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AppException(<span class="string">&quot;PKYWDHCONFIG不可为空！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        StringBuilder rklxString = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        List&lt;Integer&gt; rklxList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; ywdhConfigMap : ywdhConfigs) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; dbYwdhConfigMap = ywdhConfigRepository.selectYwdhConfig(ywdhConfigMap).get(<span class="number">0</span>);</span><br><span class="line">            YwdhConfig dbYwdhConfig = getBean(dbYwdhConfigMap);</span><br><span class="line">            <span class="comment">// 删除配置规则</span></span><br><span class="line">            DBA.delete(<span class="keyword">null</span>, dbYwdhConfig);</span><br><span class="line">            <span class="comment">// 记录日志</span></span><br><span class="line">            doLogAction(dbYwdhConfig, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dbYwdhConfigMap.get(<span class="string">&quot;JTLX&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> jtlx = Integer.parseInt(dbYwdhConfigMap.get(<span class="string">&quot;JTLX&quot;</span>).toString());</span><br><span class="line">                rklxList.add(jtlx);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取key</span></span><br><span class="line">        Map&lt;String, Object&gt; ywdhConfig = ywdhConfigs.get(<span class="number">0</span>);</span><br><span class="line">        StringBuilder keyName = <span class="keyword">new</span> StringBuilder(PREFIX + <span class="string">&quot;_&quot;</span> + ywdhConfig.get(<span class="string">&quot;SQBM&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (ywdhConfig.get(<span class="string">&quot;LX&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Long dhlx = YwdhOpsEnum.getOpcode(Integer.parseInt(ywdhConfig.get(<span class="string">&quot;LX&quot;</span>).toString()));</span><br><span class="line">            keyName.append(<span class="string">&quot;_&quot;</span>).append(dhlx);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ywdhConfig.get(<span class="string">&quot;KSLX&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Integer kslx = Integer.parseInt(ywdhConfig.get(<span class="string">&quot;KSLX&quot;</span>).toString());</span><br><span class="line">            keyName.append(<span class="string">&quot;_&quot;</span>).append(kslx);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!rklxList.isEmpty()) &#123;</span><br><span class="line">            List&lt;Integer&gt; sorted = rklxList.stream().sorted().collect(Collectors.toList());</span><br><span class="line">            sorted.forEach(rklxString::append);</span><br><span class="line">            keyName.append(<span class="string">&quot;_&quot;</span>).append(rklxString);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除redis</span></span><br><span class="line">        redisTemplate.delete(keyName.toString());</span><br><span class="line">        <span class="comment">// 删除mysql键值</span></span><br><span class="line">        YwdhRedisPair pairCondition = <span class="keyword">new</span> YwdhRedisPair();</span><br><span class="line">        pairCondition.setSqbm(ywdhConfig.get(<span class="string">&quot;SQBM&quot;</span>).toString());</span><br><span class="line">        pairCondition.setKeyname(keyName.toString());</span><br><span class="line">        List&lt;YwdhRedisPair&gt; queryResult = ywdhRedisPairRepository.selectYwdhKeyConfig(pairCondition);</span><br><span class="line">        <span class="keyword">if</span> (!queryResult.isEmpty()) &#123;</span><br><span class="line">            ywdhRedisPairRepository.deleteYwdhKeyConfig(queryResult.get(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FuncResult().setMsg(<span class="string">&quot;删除成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Map类型数据的实体类对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataMap 入参配置信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 类对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> YwdhConfig <span class="title">getBean</span><span class="params">(Map&lt;String, Object&gt; dataMap)</span> </span>&#123;</span><br><span class="line">        YwdhConfig bean = <span class="keyword">new</span> YwdhConfig();</span><br><span class="line">        mapToBean(dataMap, bean, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对一次UPDATE里面仅有新增的操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> configBeanList    入参配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jtlxList0         改之前的具体类型列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jtlxList1         现在的具体类型列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentTimeMillis 系统当前时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doOnlyAddAction</span><span class="params">(List&lt;YwdhConfig&gt; configBeanList, List&lt;Integer&gt; jtlxList0, List&lt;Integer&gt; jtlxList1, String currentTimeMillis)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            currenttimeVersion（乐观锁标识），</span></span><br><span class="line"><span class="comment">            以时间戳实现乐观锁，只有每次修改前从数据库查出来的时间戳和修改时数据库的数据仍然为此值时，才允许修改数据，</span></span><br><span class="line"><span class="comment">            否则已经发生了并行操作，不允许修改。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String currenttimeVersion = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        YwdhConfig param = configBeanList.get(<span class="number">0</span>);</span><br><span class="line">        Map&lt;String, Object&gt; condi = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">        condi.put(<span class="string">&quot;sqbm&quot;</span>, param.getSqbm());</span><br><span class="line">        condi.put(<span class="string">&quot;dhqz&quot;</span>, param.getDhqz());</span><br><span class="line">        condi.put(<span class="string">&quot;lx&quot;</span>, param.getLx());</span><br><span class="line">        condi.put(<span class="string">&quot;kslx&quot;</span>, param.getKslx());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录具体类型id值并且修改时间戳</span></span><br><span class="line">        List&lt;YwdhConfig&gt; queryConfigBeanList = DBA.find(YwdhConfig.class, condi, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">for</span> (YwdhConfig config : queryConfigBeanList) &#123;</span><br><span class="line">            currenttimeVersion = config.getCurrenttime();</span><br><span class="line">            jtlxList0.add(config.getJtlx());</span><br><span class="line">            config.setCurrenttime(currentTimeMillis);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (YwdhConfig config : configBeanList) &#123;</span><br><span class="line">            jtlxList1.add(config.getJtlx());</span><br><span class="line">            config.setCurrenttime(currentTimeMillis);</span><br><span class="line">        &#125;</span><br><span class="line">        jtlxList1.addAll(jtlxList0);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 乐观锁机制下执行数据修改保存操作</span></span><br><span class="line">        optimisticLockingDataChange(currenttimeVersion, queryConfigBeanList, OPTIMISTIC_LOCK_UPDATE);</span><br><span class="line">        DBA.save(<span class="keyword">null</span>, configBeanList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对一次UPDATE里面仅有删除的操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> configBeanList    入参配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jtlxList0         改之前的具体类型列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jtlxList1         现在的具体类型列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentTimeMillis 系统当前时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doOnlyDeleteAction</span><span class="params">(List&lt;YwdhConfig&gt; configBeanList, List&lt;Integer&gt; jtlxList0, List&lt;Integer&gt; jtlxList1, String currentTimeMillis)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            currenttimeVersion（乐观锁标识），</span></span><br><span class="line"><span class="comment">            以时间戳实现乐观锁，只有每次修改前从数据库查出来的时间戳和修改时数据库的数据仍然为此值时，才允许修改数据，</span></span><br><span class="line"><span class="comment">            否则已经发生了并行操作，不允许修改。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String currenttimeVersion = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        YwdhConfig param = configBeanList.get(<span class="number">0</span>);</span><br><span class="line">        Map&lt;String, Object&gt; condi = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">        condi.put(<span class="string">&quot;sqbm&quot;</span>, param.getSqbm());</span><br><span class="line">        condi.put(<span class="string">&quot;dhqz&quot;</span>, param.getDhqz());</span><br><span class="line">        condi.put(<span class="string">&quot;lx&quot;</span>, param.getLx());</span><br><span class="line">        condi.put(<span class="string">&quot;kslx&quot;</span>, param.getKslx());</span><br><span class="line"></span><br><span class="line">        List&lt;YwdhConfig&gt; queryConfigBeanList = DBA.find(YwdhConfig.class, condi, <span class="keyword">null</span>);</span><br><span class="line">        currenttimeVersion = queryConfigBeanList.get(<span class="number">0</span>).getCurrenttime();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录具体类型id值并且修改时间戳</span></span><br><span class="line">        <span class="keyword">for</span> (YwdhConfig config : queryConfigBeanList) &#123;</span><br><span class="line">            jtlxList0.add(config.getJtlx());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt; needDel = configBeanList.stream().map(YwdhConfig::getJtlx).collect(Collectors.toList());</span><br><span class="line">        List&lt;YwdhConfig&gt; retainConfigList = queryConfigBeanList.stream().filter(jtlx -&gt; !needDel.contains(jtlx.getJtlx())).collect(Collectors.toList());</span><br><span class="line">        List&lt;Integer&gt; retain = retainConfigList.stream().map(YwdhConfig::getJtlx).collect(Collectors.toList());</span><br><span class="line">        jtlxList1.addAll(retain);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (YwdhConfig config : retainConfigList) &#123;</span><br><span class="line">            config.setCurrenttime(currentTimeMillis);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt; pkids = configBeanList.stream().map(YwdhConfig::getPkywdhconfig).collect(Collectors.toList());</span><br><span class="line">        ywdhConfigRepository.deleteBusinessNumConfigByIds(pkids);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 乐观锁执行修改</span></span><br><span class="line">        optimisticLockingDataChange(currenttimeVersion, retainConfigList, OPTIMISTIC_LOCK_UPDATE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录批量删除日志</span></span><br><span class="line">        List&lt;YwdhConfig&gt; deleteSet = queryConfigBeanList.stream().filter(b -&gt; pkids.contains(b.getPkywdhconfig())).collect(Collectors.toList());</span><br><span class="line">        deleteSet.forEach(config -&gt; doLogAction(config, <span class="keyword">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对一次UPDATE里面不是仅有增加操作或不是仅有删除操作的其他操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> listArray         原生列表数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jtlxList0         改之前的具体类型列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jtlxList1         现在的具体类型列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> onlyUpdate        仅有修改的操作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentTimeMillis 系统当前时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doElseAction</span><span class="params">(List[] listArray, List&lt;Integer&gt; jtlxList0, List&lt;Integer&gt; jtlxList1, <span class="keyword">boolean</span> onlyUpdate, String currentTimeMillis)</span> </span>&#123;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; configMapList = listArray[<span class="number">0</span>];</span><br><span class="line">        List&lt;String&gt; flagList = listArray[<span class="number">1</span>];</span><br><span class="line">        List&lt;YwdhConfig&gt; configBeanList = mapsToBeans(configMapList, YwdhConfig.class, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> dataSize = configMapList.size();</span><br><span class="line">        Integer czryid = Integer.parseInt(LoginHelper.getLoginerId().toString());</span><br><span class="line">        List&lt;YwdhConfig&gt; allDbConfigBeans = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!onlyUpdate) &#123;</span><br><span class="line">            <span class="comment">// 获取所涉及到的所有具体类型的数据库记录</span></span><br><span class="line">            allDbConfigBeans = getYwdhConfigs(configMapList, flagList);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过flag类型来进行相应的操作，日志记录等</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dataSize; i++) &#123;</span><br><span class="line">            String flag = flagList.get(i);</span><br><span class="line">            Map&lt;String, Object&gt; map = configMapList.get(i);</span><br><span class="line">            YwdhConfig bean = configBeanList.get(i);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (WebServiceUtils.rowOp_add.equalsIgnoreCase(flag)) &#123;</span><br><span class="line">                bean.setCurrenttime(currentTimeMillis);</span><br><span class="line">                bean.setCzryid(czryid);</span><br><span class="line">                <span class="comment">// 新增</span></span><br><span class="line">                DBA.save(<span class="keyword">null</span>, bean);</span><br><span class="line">                <span class="comment">// 记录具体类型id值</span></span><br><span class="line">                jtlxList1.add(bean.getJtlx());</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (WebServiceUtils.rowOp_delete.equalsIgnoreCase(flag)) &#123;</span><br><span class="line">                YwdhConfig</span><br><span class="line">                        paramConfig = getBean(map),</span><br><span class="line">                        dbConfig = getBean(ywdhConfigRepository.selectYwdhConfig(map).get(<span class="number">0</span>));</span><br><span class="line">                <span class="comment">// 乐观锁机制执行删除</span></span><br><span class="line">                List&lt;YwdhConfig&gt; deleteConfigBeanList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                deleteConfigBeanList.add(paramConfig);</span><br><span class="line">                optimisticLockingDataChange(dbConfig.getCurrenttime(), deleteConfigBeanList, OPTIMISTIC_LOCK_DELETE);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 记录删除日志</span></span><br><span class="line">                doLogAction(dbConfig, <span class="keyword">null</span>);</span><br><span class="line">                <span class="comment">// 记录具体类型id值</span></span><br><span class="line">                jtlxList0.add(dbConfig.getJtlx());</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (WebServiceUtils.rowOp_update.equalsIgnoreCase(flag)) &#123;</span><br><span class="line">                YwdhConfig</span><br><span class="line">                        paramConfig = getBean(map),</span><br><span class="line">                        dbConfig = getBean(ywdhConfigRepository.selectYwdhConfig(map).get(<span class="number">0</span>));</span><br><span class="line">                paramConfig.setCurrenttime(currentTimeMillis);</span><br><span class="line">                paramConfig.setCzryid(czryid);</span><br><span class="line">                <span class="comment">// 乐观锁机制执行修改</span></span><br><span class="line">                List&lt;YwdhConfig&gt; updateConfigBeanList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                updateConfigBeanList.add(paramConfig);</span><br><span class="line">                optimisticLockingDataChange(dbConfig.getCurrenttime(), updateConfigBeanList, OPTIMISTIC_LOCK_UPDATE);</span><br><span class="line">                <span class="comment">// 记录修改日志</span></span><br><span class="line">                doLogAction(dbConfig, paramConfig);</span><br><span class="line">                <span class="comment">// 记录具体类型id值</span></span><br><span class="line">                jtlxList0.add(dbConfig.getJtlx());</span><br><span class="line">                jtlxList1.add(dbConfig.getJtlx());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!onlyUpdate) &#123;</span><br><span class="line">            <span class="comment">// 可能有增删和未修改的数据，需要对未修改的数据执行相关操作</span></span><br><span class="line">            doMoreAction(allDbConfigBeans, jtlxList0, jtlxList1, currentTimeMillis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 乐观锁机制执行数据改动（UPDATE、DELETE）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currenttimeVersion 乐观锁标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> changeDataList     需要进行改动的数据列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> flag               UPDATE or DELETE</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">optimisticLockingDataChange</span><span class="params">(String currenttimeVersion, List&lt;YwdhConfig&gt; changeDataList, String flag)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (OPTIMISTIC_LOCK_UPDATE.equalsIgnoreCase(flag)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (YwdhConfig config : changeDataList) &#123;</span><br><span class="line">                StringBuilder spliceSQL = <span class="keyword">new</span> StringBuilder(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                Class&lt;YwdhConfig&gt; c = YwdhConfig.class;</span><br><span class="line">                Field[] fields = c.getDeclaredFields();</span><br><span class="line">                <span class="comment">// 反射拼接更新语句的SET项</span></span><br><span class="line">                <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    Class&lt;?&gt; type = field.getType();</span><br><span class="line">                    String name = field.getName();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">&quot;createdAt&quot;</span>.equalsIgnoreCase(name) || <span class="string">&quot;updatedAt&quot;</span>.equalsIgnoreCase(name)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    Object value = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        value = field.get(config);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (type == String.class) &#123;</span><br><span class="line">                        spliceSQL.append(name).append(<span class="string">&quot;=&#x27;&quot;</span>).append(value).append(<span class="string">&quot;&#x27;,&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        spliceSQL.append(name).append(<span class="string">&quot;=&quot;</span>).append(value).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                String sqlToString = spliceSQL.substring(<span class="number">0</span>, spliceSQL.length() - <span class="number">1</span>);</span><br><span class="line">                String updateSQL = <span class="string">&quot;update ywdh_config set &quot;</span> + sqlToString + <span class="string">&quot; where PKYWDHCONFIG=&quot;</span> + config.getPkywdhconfig() + <span class="string">&quot; and CURRENTTIME=&quot;</span> + currenttimeVersion;</span><br><span class="line">                <span class="keyword">if</span> (DBA.executeSQL(updateSQL, <span class="keyword">null</span>) != <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AppException(<span class="string">&quot;当前页面数据已被更改，请刷新页面后再试！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (OPTIMISTIC_LOCK_DELETE.equalsIgnoreCase(flag)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (YwdhConfig config : changeDataList) &#123;</span><br><span class="line">                String deleteSQL = <span class="string">&quot;delete from ywdh_config where PKYWDHCONFIG=&quot;</span> + config.getPkywdhconfig() + <span class="string">&quot; and CURRENTTIME=&quot;</span> + currenttimeVersion;</span><br><span class="line">                <span class="keyword">if</span> (DBA.executeSQL(deleteSQL, <span class="keyword">null</span>) != <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AppException(<span class="string">&quot;当前页面数据已被更改，请刷新页面后再试！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所涉及到的所有具体类型的数据库记录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> configMapList 入参配置集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> flagList      入参标志集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 所有相关的配置项（即每一个具体类型的数据记录）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;YwdhConfig&gt; <span class="title">getYwdhConfigs</span><span class="params">(List&lt;Map&lt;String, Object&gt;&gt; configMapList, List&lt;String&gt; flagList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> dataSize = configMapList.size();</span><br><span class="line">        List&lt;YwdhConfig&gt; allDbConfigBeans;</span><br><span class="line">        Map&lt;String, Object&gt; oneMap = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dataSize; i++) &#123;</span><br><span class="line">            <span class="comment">// 随便选择一个修改的或者删除的（为了获取时间戳），通过时间戳查询数据库里的所有config</span></span><br><span class="line">            <span class="keyword">boolean</span> deleteOrUpdate = WebServiceUtils.rowOp_delete.equalsIgnoreCase(flagList.get(i))</span><br><span class="line">                    || WebServiceUtils.rowOp_update.equalsIgnoreCase(flagList.get(i));</span><br><span class="line">            <span class="keyword">if</span> (deleteOrUpdate) &#123;</span><br><span class="line">                oneMap = configMapList.get(i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        String dbTime =</span><br><span class="line">                ywdhConfigRepository.selectYwdhConfig(oneMap)</span><br><span class="line">                        .get(<span class="number">0</span>).get(<span class="string">&quot;CURRENTTIME&quot;</span>).toString();</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; condi = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        condi.put(<span class="string">&quot;SQBM&quot;</span>, LoginHelper.getLoginerSQBM());</span><br><span class="line">        condi.put(<span class="string">&quot;CURRENTTIME&quot;</span>, dbTime);</span><br><span class="line">        allDbConfigBeans = mapsToBeans(ywdhConfigRepository.selectYwdhConfig(condi),</span><br><span class="line">                YwdhConfig.class, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> allDbConfigBeans;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 可能有增删和未修改的数据，需要对未修改的数据执行相关操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> allDbConfigBeans  涉及到的所有具体类型的业务配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jtlxList0         改之前的具体类型列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jtlxList1         现在的具体类型列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentTimeMillis 系统当前时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doMoreAction</span><span class="params">(List&lt;YwdhConfig&gt; allDbConfigBeans, List&lt;Integer&gt; jtlxList0, List&lt;Integer&gt; jtlxList1, String currentTimeMillis)</span> </span>&#123;</span><br><span class="line">        List&lt;YwdhConfig&gt; unchangedList =</span><br><span class="line">                allDbConfigBeans.stream()</span><br><span class="line">                        .filter(b -&gt; !jtlxList0.contains(b.getJtlx()) &amp;&amp; !jtlxList1.contains(b.getJtlx()))</span><br><span class="line">                        .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt; unchangedJtlxs =</span><br><span class="line">                unchangedList.stream()</span><br><span class="line">                        .map(YwdhConfig::getJtlx).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        jtlxList0.addAll(unchangedJtlxs);</span><br><span class="line">        jtlxList1.addAll(unchangedJtlxs);</span><br><span class="line"></span><br><span class="line">        unchangedList.forEach(b -&gt; b.setCurrenttime(currentTimeMillis));</span><br><span class="line">        DBA.update(<span class="keyword">null</span>, unchangedList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行Redis的单号起始号改动以及在MySQL做好备份（用作在Redis数据丢失之后通过MySQL找回数据）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> configBeanList    入参配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jtlxStr0          改之前的具体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jtlxStr1          现在的具体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> currentTimeMillis 系统当前时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">syncAndBackup</span><span class="params">(List&lt;YwdhConfig&gt; configBeanList, StringBuilder jtlxStr0, StringBuilder jtlxStr1, String currentTimeMillis)</span> </span>&#123;</span><br><span class="line">        String sqbm = LoginHelper.getLoginerSQBM();</span><br><span class="line">        YwdhConfig config = configBeanList.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取keyName</span></span><br><span class="line">        StringBuilder</span><br><span class="line">                keyName0 = <span class="keyword">new</span> StringBuilder(PREFIX + <span class="string">&quot;_&quot;</span> + sqbm),</span><br><span class="line">                keyName1 = <span class="keyword">new</span> StringBuilder(PREFIX + <span class="string">&quot;_&quot;</span> + sqbm);</span><br><span class="line">        <span class="keyword">if</span> (config.getLx() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Long dhlx = YwdhOpsEnum.getOpcode(config.getLx());</span><br><span class="line">            keyName0.append(<span class="string">&quot;_&quot;</span>).append(dhlx);</span><br><span class="line">            keyName1.append(<span class="string">&quot;_&quot;</span>).append(dhlx);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config.getKslx() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            keyName0.append(<span class="string">&quot;_&quot;</span>).append(config.getKslx());</span><br><span class="line">            keyName1.append(<span class="string">&quot;_&quot;</span>).append(config.getKslx());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(jtlxStr0) &amp;&amp; !Objects.equals(<span class="string">&quot;null&quot;</span>, jtlxStr0.toString())) &#123;</span><br><span class="line">            keyName0.append(<span class="string">&quot;_&quot;</span>).append(jtlxStr0);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(jtlxStr1) &amp;&amp; !Objects.equals(<span class="string">&quot;null&quot;</span>, jtlxStr1.toString())) &#123;</span><br><span class="line">            keyName1.append(<span class="string">&quot;_&quot;</span>).append(jtlxStr1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除mysql旧键值</span></span><br><span class="line">        YwdhRedisPair pair0 = <span class="keyword">new</span> YwdhRedisPair(<span class="keyword">null</span>, <span class="keyword">null</span>, sqbm, keyName0.toString(), <span class="keyword">null</span>);</span><br><span class="line">        List&lt;YwdhRedisPair&gt; pairQueryResult = ywdhRedisPairRepository.selectYwdhKeyConfig(pair0);</span><br><span class="line">        DBA.delete(<span class="keyword">null</span>, pairQueryResult);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加mysql新键值</span></span><br><span class="line">        YwdhRedisPair pair1 = <span class="keyword">new</span> YwdhRedisPair(<span class="keyword">null</span>, currentTimeMillis, sqbm, keyName1.toString(), config.getDhqsh().toString());</span><br><span class="line">        DBA.save(<span class="keyword">null</span>, pair1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除旧redis</span></span><br><span class="line">        redisTemplate.delete(keyName0.toString());</span><br><span class="line">        <span class="comment">// 添加新redis</span></span><br><span class="line">        callRedisToSetKeyAndExpiration(keyName1.toString(), Integer.parseInt(config.getDhqsh().toString()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过反射记录日志</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> from 从什么</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> to   变成了什么</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doLogAction</span><span class="params">(YwdhConfig from, YwdhConfig to)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span></span><br><span class="line">                del = from != <span class="keyword">null</span> &amp;&amp; to == <span class="keyword">null</span>,</span><br><span class="line">                mod = from != <span class="keyword">null</span> &amp;&amp; to != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        DBAgent dba = DBAgent.getInstance();</span><br><span class="line">        <span class="comment">// 获取所有字段</span></span><br><span class="line">        Field[] fields = YwdhConfig.class.getDeclaredFields();</span><br><span class="line">        LogCzrz rz = <span class="keyword">new</span> LogCzrz();</span><br><span class="line">        StringBuilder tableColumn = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        StringBuilder xgxx = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            <span class="comment">// 获取属性名</span></span><br><span class="line">            String attrName = field.getName();</span><br><span class="line">            <span class="comment">// 将属性名的首字母变为大写，为set/get方法做准备</span></span><br><span class="line">            String methodName = attrName.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + attrName.substring(<span class="number">1</span>);</span><br><span class="line">            Object result = <span class="keyword">null</span>;</span><br><span class="line">            Object dbObj = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 获取类当前属性的set/getXXX方法（只获取公有方法）</span></span><br><span class="line">                Method method = YwdhConfig.class.getMethod(<span class="string">&quot;get&quot;</span> + methodName);</span><br><span class="line">                <span class="comment">// 执行该方法</span></span><br><span class="line">                <span class="keyword">if</span> (mod) &#123;</span><br><span class="line">                    result = method.invoke(to);</span><br><span class="line">                &#125;</span><br><span class="line">                dbObj = method.invoke(from);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException | IllegalAccessException | InvocationTargetException e) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    result = field.get(to);</span><br><span class="line">                    dbObj = field.get(from);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException illegalAccessException) &#123;</span><br><span class="line">                    illegalAccessException.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 修改又是字段给的null，这种情况不记录日志，其他都记录</span></span><br><span class="line">            <span class="keyword">if</span> (!mod || result != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 判断字段并进行日志记录</span></span><br><span class="line">                <span class="keyword">if</span> (!Objects.equals(dbObj, result)) &#123;</span><br><span class="line">                    tableColumn.append(attrName).append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">                    xgxx.append(attrName).append(<span class="string">&quot;: &quot;</span>).append(dbObj).append(<span class="string">&quot; -&gt; &quot;</span>).append(result).append(<span class="string">&quot; | &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (tableColumn.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            rz.setTableName(<span class="string">&quot;ywdh_config&quot;</span>);</span><br><span class="line">            rz.setTableId(from.getPkywdhconfig().toString());</span><br><span class="line">            rz.setSqbm(LoginHelper.getLoginerSQBM());</span><br><span class="line">            rz.setXgysbm(LoginHelper.getLoginerBm());</span><br><span class="line">            rz.setXgysmc(LoginHelper.getLoginerName());</span><br><span class="line">            rz.setTableColumn(tableColumn.toString());</span><br><span class="line">            rz.setXgxx(xgxx.toString());</span><br><span class="line">            Map&lt;String, Integer&gt; m = DateTransUtil.getOLEDateFromDate(<span class="keyword">new</span> Date());</span><br><span class="line">            rz.setXgrq(m.get(<span class="string">&quot;days&quot;</span>));</span><br><span class="line">            rz.setXgsj(m.get(<span class="string">&quot;second&quot;</span>));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                InetAddress host = InetAddress.getLocalHost();</span><br><span class="line">                rz.setMachineIp(host.getHostAddress());</span><br><span class="line">                rz.setMachineName(host.getHostName());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">                rz.setMachineName(<span class="keyword">null</span>);</span><br><span class="line">                rz.setMachineIp(<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            dba.save(<span class="string">&quot;LogCzrz&quot;</span>, rz);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 已经进行了业务单号配置的科室将不允许再次设置</span></span><br><span class="line"><span class="comment">     * 一个用户不可对同一社区，同一单号类型，同一药库，同一具体操作设置两套不同的规则</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> config 业务单号配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkAvailability</span><span class="params">(YwdhConfig config)</span> </span>&#123;</span><br><span class="line">        String sqbm = config.getSqbm() == <span class="keyword">null</span> ? LoginHelper.getLoginerSQBM() : config.getSqbm();</span><br><span class="line">        HashMap&lt;String, Object&gt; condition = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">        condition.put(<span class="string">&quot;SQBM&quot;</span>, sqbm);</span><br><span class="line">        <span class="keyword">if</span> (config.getLx() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            condition.put(<span class="string">&quot;LX&quot;</span>, config.getLx());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config.getKslx() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            condition.put(<span class="string">&quot;KSLX&quot;</span>, config.getKslx());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config.getJtlx() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            condition.put(<span class="string">&quot;JTLX&quot;</span>, config.getJtlx());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; queryResult = ywdhConfigRepository.selectYwdhConfig(condition);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!queryResult.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AppException(<span class="string">&quot;配置 lx:&quot;</span> + config.getLx() + <span class="string">&quot; kslx:&quot;</span> + config.getKslx() + <span class="string">&quot; jtlx:&quot;</span> + config.getJtlx() + <span class="string">&quot; 已存在！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置redis键的同时也设置他的时效性(默认采用当天有效)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callRedisToSetKeyAndExpiration</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">        Calendar calendar = <span class="keyword">new</span> GregorianCalendar();</span><br><span class="line">        <span class="comment">// 时</span></span><br><span class="line">        calendar.set(Calendar.HOUR_OF_DAY, <span class="number">23</span>);</span><br><span class="line">        <span class="comment">// 分</span></span><br><span class="line">        calendar.set(Calendar.MINUTE, <span class="number">50</span>);</span><br><span class="line">        <span class="comment">// 秒</span></span><br><span class="line">        calendar.set(Calendar.SECOND, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 毫秒</span></span><br><span class="line">        calendar.set(Calendar.MILLISECOND, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        redisTemplate.opsForValue().set(key, value);</span><br><span class="line">        redisTemplate.expireAt(key, calendar.getTime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Util"><a href="#Util" class="headerlink" title="Util"></a>Util</h2><h3 id="NumberHelper"><a href="#NumberHelper" class="headerlink" title="NumberHelper"></a>NumberHelper</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NumberHelper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成药库增序单号</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ywdhConfig 业务单号生成规则</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyName    Redis唯一键：前缀（INCR） + opcode + &quot;_&quot; + sqbm</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 业务单号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">generateIncrementSequenceNumber</span><span class="params">(YwdhConfig ywdhConfig, String keyName)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="NumberHelperImpl"><a href="#NumberHelperImpl" class="headerlink" title="NumberHelperImpl"></a>NumberHelperImpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Service(&quot;NumberHelper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NumberHelperImpl</span> <span class="keyword">implements</span> <span class="title">NumberHelper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">generateIncrementSequenceNumber</span><span class="params">(YwdhConfig config, String keyName)</span> </span>&#123;</span><br><span class="line">        DBAgent dbAgent = DBAgent.getInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 单号起始号</span></span><br><span class="line">        <span class="keyword">long</span> dhqsh = Long.parseLong(config.getDhqsh().toString());</span><br><span class="line">        <span class="keyword">if</span> (redisTemplate.hasKey(keyName)) &#123;</span><br><span class="line">            <span class="comment">// 单号步长</span></span><br><span class="line">            <span class="keyword">long</span> dhbc = Long.parseLong(config.getDhbc().toString());</span><br><span class="line">            dhqsh = redisTemplate.opsForValue().increment(keyName, dhbc);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(keyName, dhqsh);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 单号长度</span></span><br><span class="line">        Integer dhcd = config.getDhcd();</span><br><span class="line">        <span class="comment">// 前补零操作</span></span><br><span class="line">        String str = IntStream.range(<span class="number">0</span>, dhcd).mapToObj(i -&gt; <span class="string">&quot;0&quot;</span>).collect(Collectors.joining());</span><br><span class="line">        DecimalFormat df = <span class="keyword">new</span> DecimalFormat(str);</span><br><span class="line">        String format = df.format(dhqsh);</span><br><span class="line"></span><br><span class="line">        String s = <span class="string">&quot;select BM from zd_ks where sqbm = ::SQBM and sysid = ::SYSID&quot;</span>;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;SQBM&quot;</span>, config.getSqbm());</span><br><span class="line">        map.put(<span class="string">&quot;SYSID&quot;</span>, config.getKslx());</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; result = dbAgent.querySQL(s, map, <span class="keyword">null</span>);</span><br><span class="line">        Object bm = result.get(<span class="number">0</span>).get(<span class="string">&quot;BM&quot;</span>);</span><br><span class="line">        <span class="comment">// 拼接单号，比如首单入库将可拼接为：RK0380000000000001</span></span><br><span class="line">        <span class="keyword">return</span> config.getDhqz() + bm + format;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="具体业务（药库入库）"><a href="#具体业务（药库入库）" class="headerlink" title="具体业务（药库入库）"></a>具体业务（药库入库）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">public FuncResult businessYkrk(Map dataMap) &#123;</span><br><span class="line">    DBAgent dba = DBAgent.getInstance();</span><br><span class="line">    List[] ykrkd0 = (List[]) dataMap.get(&quot;YK_RKD0&quot;);</span><br><span class="line">    List[] ykrkd1 = (List[]) dataMap.get(&quot;YK_RKD1&quot;);</span><br><span class="line">    Map&lt;String, Object&gt; ykrkd = (Map&lt;String, Object&gt;) ykrkd0[0].get(0);</span><br><span class="line">    String sqbm = LoginHelper.getLoginerSQBM();</span><br><span class="line">    int czryid = Integer.parseInt(LoginHelper.getLoginerId().toString());</span><br><span class="line"></span><br><span class="line">    // 通过配置来判断是否递增生成入库单号</span><br><span class="line">    YwdhConfig config = null;</span><br><span class="line">    boolean isIncrement = false;</span><br><span class="line"></span><br><span class="line">    // 按客户端页面给的类型来筛查，寻找相应的配置。</span><br><span class="line">    Map&lt;String, Object&gt; condi = new HashMap&lt;&gt;(8);</span><br><span class="line">    condi.put(&quot;SQBM&quot;, sqbm);</span><br><span class="line">    condi.put(&quot;CZRYID&quot;, czryid);</span><br><span class="line">    condi.put(&quot;LX&quot;, YwdhOpsEnum.getLx(G3GlobalNames.YK_RKD0));</span><br><span class="line">    // 药库类型</span><br><span class="line">    if (ykrkd.get(&quot;KFID&quot;) != null) &#123;</span><br><span class="line">        condi.put(&quot;KSLX&quot;, ykrkd.get(&quot;KFID&quot;));</span><br><span class="line">    &#125; else if (ykrkd.get(&quot;kfid&quot;) != null) &#123;</span><br><span class="line">        condi.put(&quot;KSLX&quot;, ykrkd.get(&quot;kfid&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 入库类型</span><br><span class="line">    if (ykrkd.get(&quot;RKLX&quot;) != null) &#123;</span><br><span class="line">        condi.put(&quot;JTLX&quot;, ykrkd.get(&quot;RKLX&quot;));</span><br><span class="line">    &#125; else if (ykrkd.get(&quot;rklx&quot;) != null) &#123;</span><br><span class="line">        condi.put(&quot;JTLX&quot;, ykrkd.get(&quot;rklx&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 获取单号的配置规则</span><br><span class="line">    List&lt;YwdhConfig&gt; queryBeanResult =</span><br><span class="line">            mapsToBeans(ywdhConfigRepository.selectYwdhConfig(condi), YwdhConfig.class, true);</span><br><span class="line"></span><br><span class="line">    if (!queryBeanResult.isEmpty()) &#123;</span><br><span class="line">        config = queryBeanResult.get(0);</span><br><span class="line">        isIncrement = Objects.equals(1, config.getIsopen());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // redis键</span><br><span class="line">    String keyName = null;</span><br><span class="line">    // redis键的原值</span><br><span class="line">    Object originalObj = null;</span><br><span class="line">    // redis键的现值</span><br><span class="line">    Object presentObj = null;</span><br><span class="line"></span><br><span class="line">    if (isIncrement) &#123;</span><br><span class="line">        // 通过配置来生成redis的key</span><br><span class="line">        YwdhRedisPair pairCondi = new YwdhRedisPair(sqbm, config.getCurrenttime());</span><br><span class="line">        List&lt;YwdhRedisPair&gt; pairSelectResult = ywdhRedisPairRepository.selectYwdhKeyConfig(pairCondi);</span><br><span class="line">        YwdhRedisPair pair = pairSelectResult.get(0);</span><br><span class="line">        keyName = pair.getKeyname();</span><br><span class="line">        originalObj = redisTemplate.opsForValue().get(keyName);</span><br><span class="line">        // redis未获取到key，从mysql进行手动恢复并为其赋值</span><br><span class="line">        if (originalObj == null) &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(keyName, Long.parseLong(pair.getValue()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 入库单号赋值替换</span><br><span class="line">        List rkd0s = ykrkd0[0];</span><br><span class="line">        List rkd0Flags = ykrkd0[1];</span><br><span class="line">        int dataSize = rkd0s.size();</span><br><span class="line">        for (int i = 0; i &lt; dataSize; i++) &#123;</span><br><span class="line">            Object rkd0Flag = rkd0Flags.get(i);</span><br><span class="line">            if (WebServiceUtils.rowOp_add.equalsIgnoreCase(rkd0Flag.toString())) &#123;</span><br><span class="line">                Object rkd0 = rkd0s.get(i);</span><br><span class="line">                Map&lt;String, Object&gt; rkd = (Map&lt;String, Object&gt;) rkd0;</span><br><span class="line">                String presentValue = dhs.generateIncrementSequenceNumber(config, keyName);</span><br><span class="line">                if (rkd.get(&quot;RKDH&quot;) != null) &#123;</span><br><span class="line">                    rkd.put(&quot;RKDH&quot;, presentValue);</span><br><span class="line">                &#125; else if (rkd.get(&quot;rkdh&quot;) != null) &#123;</span><br><span class="line">                    rkd.put(&quot;rkdh&quot;, presentValue);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        presentObj = redisTemplate.opsForValue().get(keyName);</span><br><span class="line">        Integer presentVal = Integer.parseInt(presentObj.toString());</span><br><span class="line"></span><br><span class="line">        // 生成单号之后需要修改配置信息（更新单号起始号）</span><br><span class="line">        Map&lt;String, Object&gt; update = new HashMap&lt;&gt;();</span><br><span class="line">        update.put(&quot;SQBM&quot;, sqbm);</span><br><span class="line">        update.put(&quot;CURRENTTIME&quot;, config.getCurrenttime());</span><br><span class="line">        List&lt;YwdhConfig&gt; needToUpdateConfigs =</span><br><span class="line">                mapsToBeans(ywdhConfigRepository.selectYwdhConfig(update),</span><br><span class="line">                        YwdhConfig.class, true);</span><br><span class="line">        needToUpdateConfigs.forEach(b -&gt; b.setDhqsh(presentVal));</span><br><span class="line">        dba.update(null, needToUpdateConfigs);</span><br><span class="line"></span><br><span class="line">        // 并且修改mysql键值对</span><br><span class="line">        pairSelectResult.forEach(b -&gt; b.setValue(presentVal.toString()));</span><br><span class="line">        dba.update(null, pairSelectResult);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FuncResult funcResult;</span><br><span class="line">    try &#123;</span><br><span class="line">        // TODO 调用真实的入库业务</span><br><span class="line">        funcResult = doRKAction(ykrkd0, ykrkd1);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        if (isIncrement) &#123;</span><br><span class="line">            // 发生异常需要将redis中设置的递增序列手动回滚</span><br><span class="line">            if (originalObj == null) &#123;</span><br><span class="line">                redisTemplate.delete(keyName);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                redisTemplate.opsForValue().set(keyName, originalObj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 异常抛出用作程序本身的回滚</span><br><span class="line">        throw AppException.warn(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    return funcResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


                <hr>

                

                <ul class="pager">
                    
                    
                        <li class="next">
                            <a href="/2021/09/26/mysql-master-slave/" data-toggle="tooltip" data-placement="top" title="MySQL主从复制读写分离">Next Post ▶</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Redis" title="Redis">Redis</a>
                        
                          <a class="tag" href="/tags/#Java" title="Java">Java</a>
                        
                          <a class="tag" href="/tags/#CAS" title="CAS">CAS</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://github.com/DENG-JIAAA/" target="_blank">Github</a></li>
                    
                        <li><a href="https://gitee.com/DENG-JIAAA" target="_blank">Gitee</a></li>
                    
                        <li><a href="https://www.cnblogs.com/DJOSIMON/" target="_blank">cnblogs</a></li>
                    
                        <li><a href="https://huangxuan.me/" target="_blank">Hux Blog</a></li>
                    
                        <li><a href="http://kaijun.rocks/hexo-theme-huxblog/" target="_blank">Kaijun&#39;s Blog</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>









<!-- Footer -->
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    
                        <li>
                            <a target="_blank" href="https://twitter.com/DENG_JIAAA">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                            </a>
                        </li>
                    
                    

                    
                        <li>
                            <a target="_blank" href="http://weibo.com/dengjiaaa">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a target="_blank" href="https://www.facebook.com/jia.deng.568089">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a target="_blank" href="https://github.com/DENG-JIAAA">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                            </a>
                        </li>
                    

                    

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 2020-2023 <a href="http://dengjia.top/">Jia`s Blog</a>
                    <br>
                    Theme by <a target="_blank" rel="noopener" href="https://github.com/huxpro/huxpro.github.io">Hux</a>

                    <!--<span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    Ported by <a target="_blank" rel="noopener" href="http://blog.kaijun.rocks">Kaijun</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>-->

                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) {
            o.addEventListener('load', function (e) {
                c(null, e);
            }, false);
        }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->

<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if ($('#tag_cloud').length !== 0) {
        async("http://dengjia.top/js/jquery.tagcloud.js", function () {
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>

<!-- Google Analytics -->


<!-- Baidu TongJi -->


<!-- Side Catalog -->




<!-- Image to hack wechat -->
<img src="http://dengjia.top/img/icon_wechat.png" width="0" height="0"/>
<!-- Migrate from head to bottom, no longer block render and still work -->
</body>

</html>
